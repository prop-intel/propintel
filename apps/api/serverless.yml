service: propintel-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: us-west-2
  profile: default
  memorySize: 512
  timeout: 30
  
  environment:
    STAGE: ${self:provider.stage}
    DATABASE_URL: ${env:DATABASE_URL, ''}
    S3_BUCKET: ${self:service}-${self:provider.stage}-storage
    SQS_QUEUE_URL: https://sqs.us-west-2.amazonaws.com/971422717446/${self:service}-${self:provider.stage}-crawl-jobs
    ECS_CLUSTER_ARN: arn:aws:ecs:us-west-2:971422717446:cluster/${self:service}-${self:provider.stage}
    ECS_TASK_DEFINITION: ${self:service}-${self:provider.stage}-crawl
    ECS_RENDER_TASK_DEFINITION: ${self:service}-${self:provider.stage}-render
    ECS_SUBNET_IDS: subnet-0771f1f630d611688,subnet-0bc2e48c08206e4b6
    ECS_SECURITY_GROUP: sg-07143aece0f260f67
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
    LANGFUSE_PUBLIC_KEY: ${env:LANGFUSE_PUBLIC_KEY, ''}
    LANGFUSE_SECRET_KEY: ${env:LANGFUSE_SECRET_KEY, ''}
    LANGFUSE_BASE_URL: ${env:LANGFUSE_BASE_URL, 'https://us.cloud.langfuse.com'}
    TAVILY_API_KEY: ${env:TAVILY_API_KEY, ''}
    OPENROUTER_API_KEY: ${env:OPENROUTER_API_KEY, ''}

  iam:
    role:
      statements:
        # S3 permissions
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:service}-${self:provider.stage}-storage
            - arn:aws:s3:::${self:service}-${self:provider.stage}-storage/*
        # SQS permissions
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - arn:aws:sqs:us-west-2:971422717446:${self:service}-${self:provider.stage}-crawl-jobs
        # ECS permissions
        - Effect: Allow
          Action:
            - ecs:RunTask
            - ecs:StopTask
            - ecs:DescribeTasks
          Resource: '*'
        - Effect: Allow
          Action:
            - iam:PassRole
          Resource:
            - arn:aws:iam::971422717446:role/${self:service}-${self:provider.stage}-ecs-execution
            - arn:aws:iam::971422717446:role/${self:service}-${self:provider.stage}-ecs-task
        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:5173
      allowedHeaders:
        - Content-Type
        - Authorization
        - Cookie
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true

plugins:
  - serverless-dotenv-plugin
  - serverless-esbuild
  - serverless-offline

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    packager: pnpm
    exclude:
      - '@aws-sdk/*'
    external:
      - 'aws-lambda'
    target: node20
    platform: node
    keepNames: true
    format: esm
    outputFileExtension: '.mjs'
    banner:
      js: "import { createRequire } from 'module'; import { fileURLToPath } from 'url'; import { dirname } from 'path'; const require = createRequire(import.meta.url); const __filename = fileURLToPath(import.meta.url); const __dirname = dirname(__filename);"
  serverless-offline:
    httpPort: 4000
    lambdaPort: 4001
    noPrependStageInUrl: true
    reloadHandler: true
    noTimeout: true

package:
  individually: true

functions:
  # Job Management
  createJob:
    handler: src/handlers/job.create
    timeout: 29
    events:
      - httpApi:
          path: /jobs
          method: post

  # Orchestrator (SQS Consumer)
  orchestrator:
    handler: src/handlers/orchestrator.handler
    timeout: 900
    memorySize: 1024
    events:
      - sqs:
          arn: arn:aws:sqs:us-west-2:971422717446:${self:service}-${self:provider.stage}-crawl-jobs
          batchSize: 1

  # Health Check
  health:
    handler: src/handlers/health.handler
    events:
      - httpApi:
          path: /health
          method: get

  # Dashboard Endpoints
  dashboardSummary:
    handler: src/handlers/dashboard.getSummary
    timeout: 30
    events:
      - httpApi:
          path: /dashboard/summary
          method: get

  dashboardTrends:
    handler: src/handlers/dashboard.getTrends
    timeout: 30
    events:
      - httpApi:
          path: /dashboard/trends
          method: get

  dashboardAlerts:
    handler: src/handlers/dashboard.getAlerts
    timeout: 30
    events:
      - httpApi:
          path: /alerts
          method: get

  # Scheduled Crawls
  createSchedule:
    handler: src/handlers/schedules.createSchedule
    events:
      - httpApi:
          path: /schedules
          method: post

  listSchedules:
    handler: src/handlers/schedules.listSchedules
    events:
      - httpApi:
          path: /schedules
          method: get

  deleteSchedule:
    handler: src/handlers/schedules.deleteSchedule
    events:
      - httpApi:
          path: /schedules/{id}
          method: delete

  scheduledCrawl:
    handler: src/handlers/schedules.handleScheduledCrawl
    timeout: 60

  # Documentation
  apiDocs:
    handler: src/handlers/docs.html
    events:
      - httpApi:
          path: /docs
          method: get

  openApiSpec:
    handler: src/handlers/docs.openapi
    events:
      - httpApi:
          path: /openapi.json
          method: get

resources:
  Outputs:
    ApiEndpoint:
      Description: API Gateway endpoint URL
      Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
